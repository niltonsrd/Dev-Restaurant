<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Administrativo</title>
  <link rel="icon" href="{{ settings.logo_path }}" type="image/png" />

  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
</head>

<body>
  <header class="top">
    <div class="logo-container">
      <img src="{{ settings.logo_path }}" alt="Logo" class="site-logo">
      <div class="header-texts">
        <h1>Painel Administrativo â€” {{ settings.site_title }}</h1>
        <div class="muted">Ãrea administrativa â€¢ {{ settings.site_title }}</div>
      </div>
  </header>
  <div class="tabs-wrapper">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="produtos">Produtos</div>
      <div class="tab" data-tab="vendas">Vendas</div>
      <div class="tab" data-tab="config">ConfiguraÃ§Ãµes</div>
      <div class="tab" data-tab="relatorios">RelatÃ³rios</div>
      <div class="tab" data-tab="promocoes">PromoÃ§Ãµes</div>
      <div class="tab" data-tab="logs">ğŸ“œ Logs</div>
      <form method="POST" action="/admin/logout" style="margin-left: 10px">
        <button class="logout-btn">Sair</button>
      </form>
    </div>

  </div>

  <main>
    <section id="content-area">
      <div id="produtos" class="card">
        <h2>ğŸ½ï¸ Gerenciar Produtos</h2>

        <!-- ====== FormulÃ¡rio â€” agora com tamanhos, ingredientes e adicionais dinÃ¢micos ====== -->
        <div class="add-box card">
          <h3>â• Adicionar Novo Produto</h3>
          <form action="/admin/add" method="POST" enctype="multipart/form-data" id="formAdd">
            <input type="text" name="name" placeholder="Nome" required />

            <div style="display: flex; gap: 8px">
              <input type="number" name="price" placeholder="PreÃ§o base (R$)" step="0.01" required />

              <select name="category" required style="min-width: 180px">
                <option value="">Categoria</option>
                {% for c in categorias %}
                <option value="{{ c.name }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <textarea name="description" placeholder="DescriÃ§Ã£o"></textarea>
            <input type="file" name="image" accept="image/*" />

            <div style="margin-top: 15px">
              <label class="switch-container">
                <input type="checkbox" name="customizable" value="1" id="customizableCB" />
                <span class="slider"></span>
                <span class="label-text">Produto PersonalizÃ¡vel (Habilita Tamanhos / Ingredientes / Adicionais)</span>
              </label>
            </div>

            <!-- Controles de personalizaÃ§Ã£o (visÃ­veis somente se checkbox marcado) -->
            <div id="customOptions">
              <div class="section-box">
                <strong>Tamanhos (opcionais)</strong>
                <div id="sizesContainer" style="margin-top: 8px"></div>
                <div style="margin-top: 8px">
                  <button type="button" class="btn ghost mini-btn" onclick="addSizeField()">
                    + Adicionar tamanho
                  </button>
                  <span class="small-muted">
                    Ex: Pequena +0, MÃ©dia +5.00, FamÃ­lia +12.00</span>
                </div>
              </div>

              <div class="section-box">
                <strong>Ingredientes (checkbox)</strong>
                <div id="ingredientsContainer" style="margin-top: 8px"></div>
                <div style="margin-top: 8px">
                  <button type="button" class="btn ghost mini-btn" onclick="addIngredientField()">
                    + Novo ingrediente
                  </button>
                  <span class="small-muted">Ingredientes serÃ£o salvos no banco e podem ser
                    reutilizados</span>
                </div>
              </div>

              <div class="section-box">
                <strong>Adicionais (opcionais)</strong>
                <div id="extrasContainer" style="margin-top: 8px"></div>
                <div style="margin-top: 8px">
                  <button type="button" class="btn ghost mini-btn" onclick="addExtraField()">
                    + Adicionar adicional
                  </button>
                  <span class="small-muted">Adicionais cobram valor extra por item</span>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 12px">
              <button class="btn" type="submit">Adicionar</button>
              <button class="btn ghost" type="button"
                onclick="document.getElementById('formAdd').reset(); hideCustomOptions();">
                Limpar
              </button>
            </div>
          </form>
        </div>

        <!-- modal de pedido (mantido) -->
        <div id="modalNovoPedido">
          <div class="box">
            <h2>ğŸ“¦ Novo Pedido Recebido!</h2>
            <p id="pedidoModalTexto"></p>
            <button onclick="abrirVendasPorModal()">Ver Pedido</button>
          </div>
        </div>

        <div id="newOrderAlert"></div>

        <!-- ===== Lista de produtos ===== -->
        <h3 style="margin-top: 14px">ğŸ“¦ Produtos Cadastrados</h3>
        <div class="grid" id="productGrid">
          {% for p in products %}
          <div class="product-card">
            <img src="/static/img/{{ p.image }}" alt="{{ p.name }}" onerror="this.src='/static/img/default.png'" />
            <div class="product-body">
              <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: start;
                  ">
                <div>
                  <div style="font-weight: 700">{{ p.name }}</div>
                  <div class="muted">{{ p.category }}</div>
                  {% if p.customizable %}
                  <div class="small-muted">PersonalizÃ¡vel</div>
                  {% endif %}
                </div>
                <div style="text-align: right">
                  <div style="font-weight: 700">
                    R$ {{ '%.2f'|format(p.price) }}
                  </div>
                </div>
              </div>

              <div style="margin-top: 8px; color: var(--muted); font-size: 13px">
                {{ p.description }}
              </div>
            </div>

            <div class="card-actions">
              <button class="btn ghost"
                onclick="openEdit('{{ p.id }}','{{ p.name }}','{{ p.price }}','{{ p.category }}',`{{ p.description }}`)">
                Editar
              </button>

              <button class="btn ghost" onclick="openVariations('{{ p.id }}')">
                Gerenciar
              </button>

              <form action="/admin/delete/{{ p.id }}" method="POST" style="display: inline">
                <button class="btn btn-danger">Excluir</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- resto das tabs (vendas / relatorios / config) mantidos sem grandes alteraÃ§Ãµes -->
      <div id="vendas" class="card" style="display: none">
        <h2>ğŸ›’ Vendas</h2>

        <div class="vendas-filters">
          <input type="text" id="searchCliente" placeholder="Buscar por cliente ou ID" />
          <input type="date" id="dateFrom" />
          <input type="date" id="dateTo" />
          <select id="filterStatus">
            <option value="">Todos status</option>
            <option value="pendente">Pendente</option>
            <option value="recebido">Recebido</option>
            <option value="pronto">Pronto</option>
            <option value="saiu_entrega">Saiu para entrega</option>
          </select>

          <button class="btn" onclick="loadVendas()">Atualizar</button>
        </div>

        <div style="overflow: auto">
          <table class="table" id="vendasTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Pagamento</th>
                <th>Data</th>
                <th>Status</th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="vendasBody"></tbody>
          </table>
        </div>
      </div>

      <div id="relatorios" class="card" style="display: none">
        <h2>ğŸ“Š RelatÃ³rios de Vendas</h2>

        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
        <div class="mb-4" style="margin-bottom: 15px">
          <button class="btn btn-primary active" id="btn-diario" data-periodo="diario">
            Hoje Â  Â  Â  Â  Â  Â 
          </button>

          <button class="btn ghost" id="btn-semanal" data-periodo="semanal">
            Ãšltimos 7 dias Â  Â  Â  Â  Â  Â 
          </button>

          <button class="btn ghost" id="btn-mensal" data-periodo="mensal">
            Ãšltimos 30 dias Â  Â  Â  Â  Â  Â 
          </button>

          <div style="margin-top: 20px; margin-bottom: 20px">
            <button class="btn btn-danger" id="btn-download-pdf">
              â¬‡ï¸ Baixar RelatÃ³rio Detalhado em (CSV/Excel)
            </button>
            <button class="btn btn-success" onclick="baixarRelatorioExcel()">
              â¬‡ï¸ Baixar RelatÃ³rio Premium (Excel)
            </button>

          </div>
        </div>

        <div class="row-cards" style="display: flex; gap: 15px; flex-wrap: wrap">
          <div class="card shadow border-success py-2" style="flex: 1; min-width: 250px; padding: 15px">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
              Total Arrecadado (<span id="periodo-texto">Hoje</span>) Â  Â  Â  Â 
              Â  Â  Â 
            </div>

            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-arrecadado"
              style="font-size: 1.5em; font-weight: bold">
              Carregando... Â  Â  Â  Â  Â  Â  Â 
            </div>
          </div>

          <div class="card shadow border-info py-2" style="flex: 1; min-width: 250px; padding: 15px">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              Total de Pedidos (<span id="periodo-texto-2">Hoje</span>) Â  Â  Â 
              Â  Â  Â  Â 
            </div>

            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-vendas"
              style="font-size: 1.5em; font-weight: bold">
              Carregando... Â  Â  Â  Â  Â  Â  Â 
            </div>
          </div>
        </div>

        <div style="margin-top: 15px">
          <p class="muted" id="data-inicio-relatorio">
            Dados a partir de: Carregando...
          </p>
        </div>
      </div>

      <div id="config" class="card" style="display: none">
        <h2>âš™ï¸ ConfiguraÃ§Ãµes</h2>
        <div class="muted">
          Gerencie as informaÃ§Ãµes e aparÃªncia do sistema
        </div>

        <form id="configForm" action="/admin/configuracoes/salvar" method="POST" enctype="multipart/form-data"
          style="margin-top: 16px; display: grid; gap: 16px">
          <!-- ğŸ“± CONFIGURAÃ‡Ã•ES BÃSICAS -->
          <div class="card">
            <h3>ğŸ“± BÃ¡sico do Site</h3>

            <div style="display: grid; gap: 10px">
              <label class="small">Telefone para WhatsApp</label>
              <input type="text" name="whatsapp_number" value="{{ settings.whatsapp_number }}" />

              <label class="small">TÃ­tulo do Restaurante</label>
              <input type="text" name="site_title" value="{{ settings.site_title }}" />

              <label class="small">DescriÃ§Ã£o</label>
              <textarea name="site_description" style="min-height: 70px">{{ settings.site_description }}</textarea>
            </div>
          </div>

          <!-- ğŸª DADOS DA LOJA -->
          <div class="card">
            <h3>ğŸª Dados da Loja</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
              <div>
                <label>CNPJ</label>
                <input type="text" name="cnpj" value="{{ settings.cnpj or '' }}" />
              </div>

              <div>
                <label>Estado</label>
                <input type="text" name="address_state" value="{{ settings.address_state or '' }}" />
              </div>

              <div style="grid-column: span 2">
                <label>Rua</label>
                <input type="text" name="address_street" value="{{ settings.address_street or '' }}" />
              </div>

              <div>
                <label>NÃºmero</label>
                <input type="text" name="address_number" value="{{ settings.address_number or '' }}" />
              </div>

              <div>
                <label>Cidade</label>
                <input type="text" name="address_city" value="{{ settings.address_city or '' }}" />
              </div>
            </div>
          </div>

          <!-- ğŸ–¼ï¸ IDENTIDADE VISUAL -->
          <div class="card">
            <h3>ğŸ–¼ï¸ Identidade Visual</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px">
              <div>
                <label class="small">Logo atual</label>
                <img src="{{ settings.logo_path }}" style="height: 80px; display: block; margin-bottom: 8px" />
                <input type="file" name="logo_file" accept="image/*" />
              </div>

              <div>
                <label class="small">Imagem de fundo</label>
                <img src="{{ settings.background_path }}" style="height: 80px; display: block; margin-bottom: 8px" />
                <input type="file" name="background_file" accept="image/*" />
              </div>
            </div>
          </div>

          <!-- ğŸšš TAXA DE ENTREGA -->
          <div class="card">
            <h3>ğŸšš Taxa de Entrega</h3>

            <div style="
                  display: grid;
                  grid-template-columns: repeat(2, 1fr);
                  gap: 10px;
                ">
              <div>
                <label>CEP da Loja</label>
                <input type="text" name="delivery_cep_loja" value="{{ settings.delivery_cep_loja }}" />
              </div>

              <div>
                <label>Taxa fixa (R$)</label>
                <input type="number" step="0.01" name="delivery_taxa_fixa" value="{{ settings.delivery_taxa_fixa }}" />
              </div>

              <div>
                <label>PreÃ§o por KM (R$)</label>
                <input type="number" step="0.01" name="delivery_preco_km" value="{{ settings.delivery_preco_km }}" />
              </div>

              <div>
                <label>Taxa mÃ¡xima (R$)</label>
                <input type="number" step="0.01" name="delivery_taxa_maxima"
                  value="{{ settings.delivery_taxa_maxima }}" />
              </div>
            </div>

            <div class="small-muted" style="margin-top: 8px">
              O valor serÃ¡ calculado automaticamente com base na distÃ¢ncia.
            </div>
          </div>

          <div class="card" style="margin-top:20px">
            <h3>ğŸ’³ ConfiguraÃ§Ã£o do PIX</h3>

            <label class="small">Chave PIX</label>
            <input type="text" name="pix_key" value="{{ settings.pix_key or '' }}">

            <label class="small">Nome do Recebedor</label>
            <input type="text" name="pix_nome" value="{{ settings.pix_nome or '' }}">

            <label class="small">Banco</label>
            <input type="text" name="pix_banco" value="{{ settings.pix_banco or '' }}">

            <label class="small">Cidade</label>
            <input type="text" name="pix_cidade" value="{{ settings.pix_cidade or '' }}">

            <label class="small">DescriÃ§Ã£o padrÃ£o</label>
            <input type="text" name="pix_descricao" value="{{ settings.pix_descricao or '' }}">
          </div>



          <!-- ğŸ’¾ AÃ‡Ã•ES -->
          <div style="display: flex; gap: 10px">
            <button class="btn" type="submit">Salvar ConfiguraÃ§Ãµes</button>
            <button class="btn ghost" type="button" onclick="location.reload()">
              Cancelar
            </button>
          </div>
        </form>


        <div class="card" style="margin-top: 16px">
          <h3>ğŸ” SeguranÃ§a do Painel</h3>

          <form id="admin-change-password-form" style="display: grid; gap: 10px; margin-top: 10px">
            <label class="small">Senha atual</label>
            <div class="admin-pass-field">
              <input type="password" name="senha_atual" id="senha_atual" required />
              <button type="button" class="admin-pass-toggle" onclick="toggleAdminPassword('senha_atual', this)">
                ğŸ‘
              </button>
            </div>

            <label class="small">Nova senha</label>
            <div class="admin-pass-field">
              <input type="password" name="nova_senha" id="nova_senha" required />
              <button type="button" class="admin-pass-toggle" onclick="toggleAdminPassword('nova_senha', this)">
                ğŸ‘
              </button>
            </div>

            <label class="small">Confirmar nova senha</label>
            <div class="admin-pass-field">
              <input type="password" name="confirmar_senha" id="confirmar_senha" required />
              <button type="button" class="admin-pass-toggle" onclick="toggleAdminPassword('confirmar_senha', this)">
                ğŸ‘
              </button>
            </div>

            <button class="btn" type="submit">Alterar senha</button>

            <div class="small-muted">
              ApÃ³s alterar a senha, vocÃª serÃ¡ deslogado automaticamente.
            </div>
          </form>
        </div>

        <!-- ğŸ·ï¸ CATEGORIAS -->
        <div class="card" style="margin-top: 20px">
          <h3>ğŸ·ï¸ Categorias de Produtos</h3>
          <div class="muted">
            Gerencie as categorias utilizadas nos produtos
          </div>

          <form action="/admin/categories/add" method="POST" style="display: flex; gap: 8px; margin-top: 10px">
            <input type="text" name="nome" placeholder="Nova categoria..." required style="flex: 1" />
            <button class="btn">Adicionar</button>
          </form>

          <ul style="list-style: none; padding: 0; margin-top: 12px">
            {% for c in categorias %}
            <li style="
                  display: flex;
                  justify-content: space-between;
                  padding: 6px 0;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                ">
              <span>{{ c.name }}</span>
              <form action="/admin/categories/delete/{{ c.id }}" method="POST">
                <button class="btn btn-danger mini-btn">Excluir</button>
              </form>
            </li>
            {% else %}
            <li class="muted">Nenhuma categoria cadastrada</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div id="promocoes" class="card" style="display: none">
        <h2>ğŸ”¥ PromoÃ§Ãµes</h2>
        <div class="muted">
          Crie promoÃ§Ãµes por tempo limitado para produtos do cardÃ¡pio.
        </div>

        <!-- ğŸ”¥ LAYOUT EM DUAS COLUNAS -->
        <div class="promocoes-layout" style="margin-top:16px">

          <!-- ================= COLUNA ESQUERDA ================= -->
          <div class="promocoes-form card">
            <h3>â• Nova PromoÃ§Ã£o</h3>

            <form id="formPromocao" style="display: grid; gap: 12px">

              <label class="small">Nome da promoÃ§Ã£o</label>
              <input type="text" name="nome" required />

              <label class="small">Tipo de desconto</label>
              <select name="tipo_desconto" required>
                <option value="">Selecione</option>
                <option value="percentual">Percentual (%)</option>
                <option value="valor_fixo">Valor fixo (R$)</option>
              </select>

              <label class="small">Valor do desconto</label>
              <input type="number" step="0.01" name="valor_desconto" required />

              <label class="small">InÃ­cio da promoÃ§Ã£o</label>
              <input type="datetime-local" name="data_inicio" required />

              <label class="small">Fim da promoÃ§Ã£o</label>
              <input type="datetime-local" name="data_fim" required />

              <label class="small">Produtos em promoÃ§Ã£o</label>
              <label class="small">Produtos em promoÃ§Ã£o</label>

              <select name="produtos[]" id="produtosSelect" multiple size="6" required></select>

              <small class="muted">
                Segure <b>Ctrl</b> (Windows) ou <b>Cmd</b> (Mac) para selecionar vÃ¡rios produtos
              </small>


              <button class="btn" type="submit">Ativar PromoÃ§Ã£o</button>
            </form>
          </div>

          <!-- ================= COLUNA DIREITA ================= -->
          <div class="promocoes-lista-wrapper">
            <h3 class="section-title">ğŸ“‹ PromoÃ§Ãµes Criadas</h3>

            <div id="lista-promocoes" class="promocoes-lista">
              <p class="muted">Carregando promoÃ§Ãµes...</p>
            </div>
          </div>

        </div>
      </div>

      <div id="modalEditarPromocao" class="modal-overlay" style="display: none">
        <div class="modal">
          <h3>âœï¸ Editar PromoÃ§Ã£o</h3>

          <form id="formEditarPromocao" class="modal-form">
            <input type="hidden" name="id" />

            <label>Nome da promoÃ§Ã£o</label>
            <input type="text" name="nome" required />

            <label>Tipo de desconto</label>
            <select name="tipo_desconto" required>
              <option value="percentual">Percentual (%)</option>
              <option value="valor_fixo">Valor fixo (R$)</option>
            </select>

            <label>Valor do desconto</label>
            <input type="number" step="0.01" name="valor_desconto" required />

            <label>InÃ­cio da promoÃ§Ã£o</label>
            <input type="datetime-local" name="data_inicio" required />

            <label>Fim da promoÃ§Ã£o</label>
            <input type="datetime-local" name="data_fim" required />

            <label>Produtos em promoÃ§Ã£o</label>
            <label class="small">Produtos em promoÃ§Ã£o</label>

            <select name="produtos[]" id="editarProdutosSelect" multiple size="6"></select>

            <small class="muted">
              Segure <b>Ctrl</b> (Windows) ou <b>Cmd</b> (Mac) para selecionar vÃ¡rios produtos
            </small>


            <div class="modal-actions">
              <button type="button" class="btn ghost" onclick="fecharModalEditar()">Cancelar</button>
              <button type="submit" class="btn">Salvar AlteraÃ§Ãµes</button>
            </div>
          </form>
        </div>
      </div>


      <aside class="sidebar">
        <div class="card">
          <h3>Resumo</h3>
          <div class="muted">Vendas (Ãºltimas 24h)</div>
          <div id="resumo24" style="margin-top: 8px; font-weight: 700">â€”</div>
          <div style="height: 10px"></div>
          <h4>Pesquisar venda</h4>
          <input type="text" id="quickSearch" placeholder="Pesquisar por cliente ou ID" />
          <button class="btn" style="margin-top: 8px" onclick="quickSearch()">
            Buscar
          </button>
        </div>

        <div class="card">
          <h3>AÃ§Ãµes</h3>
          <button class="btn" onclick="loadVendas()">Atualizar vendas</button>
          <button class="btn ghost" onclick="openTab('produtos')">
            Ir para Produtos
          </button>
        </div>
      </aside>
      <div id="logs" style="display:none">

        <!-- ========================= -->
        <!-- POLÃTICA DE RETENÃ‡ÃƒO -->
        <!-- ========================= -->
        <div class="card logs-retencao">
          <h2>ğŸ—‚ï¸ PolÃ­tica de RetenÃ§Ã£o de Dados</h2>

          <p class="muted">
            Defina por quanto tempo o sistema deve manter os dados.
            InformaÃ§Ãµes mais antigas serÃ£o removidas automaticamente.
          </p>

          <label class="small">Manter dados dos Ãºltimos:</label>
          <select id="retencaoMeses">
            <option value="3">3 meses</option>
            <option value="6" selected>6 meses</option>
            <option value="12">12 meses</option>
          </select>

          <div style="display:flex; gap:10px; margin-top:16px">
            <button class="btn ghost" onclick="previewRetencao()">
              ğŸ” Visualizar impacto
            </button>

            <button class="btn btn-danger" onclick="abrirConfirmacaoRetencao()">
              âš ï¸ Aplicar polÃ­tica
            </button>
          </div>
        </div>

        <!-- ========================= -->
        <!-- LOGS DO SISTEMA -->
        <!-- ========================= -->
        <div class="card logs-section">
          <h2>ğŸ“œ Logs do Sistema</h2>

          <div class="logs-table-wrapper">
            <table class="table logs-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Tipo</th>
                  <th>AÃ§Ã£o</th>
                  <th>Pedido</th>
                  <th>DescriÃ§Ã£o</th>
                  <th>UsuÃ¡rio</th>
                </tr>
              </thead>
              <tbody id="logsBody"></tbody>
            </table>
          </div>

          <div id="logsCards" class="logs-cards"></div>
        </div>

      </div>
      <!-- ================= MODAL PREVIEW RETENÃ‡ÃƒO ================= -->
      <div id="modalPreviewRetencao" class="modal-bg" style="display:none">
        <div class="modal" style="max-width:420px">
          <h3>ğŸ” Impacto da RetenÃ§Ã£o</h3>

          <p class="muted">
            Os seguintes dados serÃ£o removidos permanentemente:
          </p>

          <div class="card" style="margin-top:12px">
            <div><b>Pedidos:</b> <span id="mPrevPedidos">0</span></div>
            <div><b>Logs:</b> <span id="mPrevLogs">0</span></div>
            <div><b>Comprovantes PIX:</b> <span id="mPrevComprovantes">0</span></div>
            <div><b>Notas fiscais:</b> <span id="mPrevNotas">0</span></div>
            <div class="muted" style="margin-top:8px">
              AtÃ©: <span id="mPrevData">--</span>
            </div>
          </div>

          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px">
            <button class="btn ghost" onclick="fecharModal('modalPreviewRetencao')">
              Fechar
            </button>
            <button class="btn btn-danger" onclick="abrirConfirmacaoRetencao()">
              âš ï¸ Executar limpeza
            </button>
          </div>
        </div>
      </div>

      <div id="modalConfirmarRetencao" class="modal-overlay" style="display:none">
        <div class="modal danger">
          <h3>âš ï¸ Confirmar polÃ­tica de retenÃ§Ã£o</h3>

          <p>
            Esta aÃ§Ã£o removerÃ¡ permanentemente dados antigos.
            <br><b>NÃ£o poderÃ¡ ser desfeita.</b>
          </p>

          <div class="modal-actions">
            <button class="btn ghost" onclick="fecharModal('modalConfirmarRetencao')">
              Cancelar
            </button>
            <button class="btn btn-danger" onclick="executarRetencao()">
              Confirmar limpeza
            </button>
          </div>
        </div>
      </div>




  </main>

  <!-- modal editar produto (mantido) -->
  <div class="modal-bg" id="modalEdit">
    <div class="modal">
      <h3>Editar Produto</h3>
      <form id="editForm" method="POST" enctype="multipart/form-data">
        <input type="text" id="editName" name="name" required />
        <input type="number" id="editPrice" name="price" step="0.01" required />
        <select id="editCategory" name="category" required>
          {% for c in categorias %}
          <option value="{{ c.name }}">{{ c.name }}</option>
          {% endfor %}
        </select>

        <textarea id="editDescription" name="description"></textarea>
        <label style="margin-top: 10px">Nova imagem (opcional)</label>
        <input type="file" name="image" />
        <div style="display: flex; gap: 8px; margin-top: 12px">
          <button class="btn" type="submit">Salvar alteraÃ§Ãµes</button>
          <button class="btn btn-danger" type="button" onclick="closeEdit()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-bg" id="modalVenda">
    <div class="modal" id="modalVendaInner">
      <h3>Detalhes da Venda <span id="vendaIdTitle"></span></h3>
      <div id="vendaInfo" class="small muted"></div>
      <div class="items" id="vendaItems"></div>
      <div id="pixComprovanteBox" style="display:none"></div>

      <div style="display: flex; gap: 8px; margin-top: 12px">
        <button class="btn" id="btnDownloadNota">Baixar Nota (PDF)</button>
        <button class="btn" id="btnMarcar">Marcar como ConcluÃ­do</button>
        <button class="btn ghost" onclick="closeVendaModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modalVariations" style="display: none">
    <div class="modal" id="variationsModalInner">
      <h3>
        Gerenciar Item <span id="varProductId" style="display: none"></span>
      </h3>
      <p class="muted">Adicione ou remova opÃ§Ãµes deste produto.</p>

      <div class="variations-grid">
        <div class="card variation-card">
          <h4>ğŸ“ Tamanhos</h4>
          <div id="listSizes" class="scroll-list"></div>
          <div class="input-group">
            <input type="text" id="inSizeName" placeholder="Ex: Grande" />

            <input type="number" id="inSizePrice" step="0.01" placeholder="PreÃ§o extra (R$)"
              class="extra-price-input" />

            <button onclick="addVariation('size')" class="btn mini-btn">
              +
            </button>
          </div>
        </div>

        <div class="card variation-card">
          <h4>ğŸ• Sabores</h4>
          <div id="listIngredients" class="scroll-list"></div>
          <div class="input-group">
            <input type="text" id="inIngName" placeholder="Ex: Queijo" />
            <button onclick="addVariation('ingredient')" class="btn mini-btn">
              +
            </button>
          </div>
        </div>

        <div class="card variation-card">
          <h4>ğŸ¥“ Adicionais (Extras)</h4>
          <div id="listExtras" class="scroll-list"></div>
          <div class="input-group">
            <input type="text" id="inExtraName" placeholder="Nome" />
            <input type="number" id="inExtraPrice" placeholder="R$" class="extra-price-input" />
            <button onclick="addVariation('extra')" class="btn mini-btn">
              +
            </button>
          </div>
        </div>
      </div>

      <button onclick="closeVariations()" class="btn ghost" style="margin-top: 20px; width: 100%">
        Fechar
      </button>
    </div>
  </div>

  <div id="admin-js-modal" style="display: none">
    <div class="admin-js-box">
      <div id="admin-js-icon" class="admin-js-icon">âœ”</div>

      <div id="admin-js-title" class="admin-js-title"></div>

      <div class="admin-js-message" id="admin-js-message"></div>

      <button class="admin-js-btn" onclick="fecharAdminModal()">OK</button>
    </div>
  </div>

  <!-- ====== MODAL TEMPO DE PREPARO ====== -->
  <div id="modalTempoPreparo" class="modal-bg" style="display: none">
    <div class="modal" style="max-width: 400px">
      <h3>â±ï¸ Tempo estimado de preparo</h3>

      <p class="muted">Informe o tempo estimado para preparo deste pedido.</p>

      <input type="number" id="inputTempoPreparo" min="1" placeholder="Ex: 35"
        style="width: 100%; padding: 10px; margin: 12px 0" />

      <div style="display: flex; justify-content: flex-end; gap: 10px">
        <button class="btn ghost" onclick="fecharModalTempo()">
          Cancelar
        </button>
        <button class="btn" onclick="confirmarTempoPreparo()">
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <div id="modalConfirmacao" class="modal-bg" style="display: none">
    <div class="modal" style="max-width: 380px">
      <h3 id="textoConfirmacao"></h3>

      <div style="
            text-align: right;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
          ">
        <button class="btn ghost" onclick="fecharModalConfirmacao()">
          Cancelar
        </button>
        <button class="btn" onclick="confirmarAlteracaoStatus()">
          Confirmar
        </button>
      </div>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay">

    <div id="modalBox" class="modal-box">

      <h3 id="modalTitle"></h3>

      <p id="modalMessage"></p>

      <div id="modalButtons" class="modal-buttons"></div>

    </div>

  </div>


  <script>
    /* ================= MODAL UNIVERSAL ================= */

    function abrirAdminModal({ message, success, type }) {
      const modal = document.getElementById("admin-js-modal");
      const icon = document.getElementById("admin-js-icon");
      const title = document.getElementById("admin-js-title");
      const msg = document.getElementById("admin-js-message");

      msg.innerText = message || "";

      if (success) {
        icon.innerText = "âœ”";
        icon.className = "admin-js-icon success";

        if (type === "senha") {
          title.innerText = "Senha alterada com sucesso";
        } else if (type === "config") {
          title.innerText = "ConfiguraÃ§Ãµes salvas";
        } else {
          title.innerText = "Sucesso";
        }
      } else {
        icon.innerText = "âœ–";
        icon.className = "admin-js-icon error";
        title.innerText = "Erro";
      }

      modal.style.display = "flex";

      // ğŸ”¥ AQUI ESTÃ A CORREÃ‡ÃƒO DEFINITIVA
      if (success && type === "config") {
        setTimeout(() => window.location.reload(), 800);
      }

      if (success && type === "senha") {
        setTimeout(() => (window.location.href = "/admin"), 800);
      }
    }

    function fecharAdminModal() {
      document.getElementById("admin-js-modal").style.display = "none";
    }

    /* ================= FETCH JSON SEGURO ================= */
    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        credentials: "same-origin",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
        ...options,
      });

      const contentType = res.headers.get("content-type") || "";

      let data;
      if (contentType.includes("application/json")) {
        data = await res.json();
      } else {
        data = {
          success: false,
          message: "Resposta invÃ¡lida do servidor.",
        };
      }

      return { res, data };
    }

    /* ================= FORM CONFIGURAÃ‡Ã•ES ================= */
    const formConfig = document.getElementById("configForm");

    if (formConfig) {
      formConfig.addEventListener("submit", async (e) => {
        e.preventDefault();

        const btn = formConfig.querySelector("button[type='submit']");
        btn.disabled = true;
        btn.innerText = "Salvando...";

        try {
          const { res, data } = await fetchJSON(
            "/admin/configuracoes/salvar",
            {
              method: "POST",
              body: new FormData(formConfig),
            }
          );

          if (res.ok && data.success) {
            abrirAdminModal({
              message: data.message || "ConfiguraÃ§Ãµes salvas com sucesso.",
              success: true,
              type: "config",
            });
          } else {
            abrirAdminModal({
              message: data.message || "Erro ao salvar configuraÃ§Ãµes.",
              success: false,
              type: "config",
            });
          }
        } catch {
          abrirAdminModal({
            message: "Erro de conexÃ£o com o servidor.",
            success: false,
            type: "config",
          });
        } finally {
          btn.disabled = false;
          btn.innerText = "Salvar ConfiguraÃ§Ãµes";
        }
      });
    }

    /* ================= FORM SENHA ================= */
    const formSenha = document.getElementById("admin-change-password-form");

    if (formSenha) {
      formSenha.addEventListener("submit", async (e) => {
        e.preventDefault();

        try {
          const { res, data } = await fetchJSON("/admin/alterar-senha", {
            method: "POST",
            body: new FormData(formSenha),
          });

          if (res.ok && data.success) {
            abrirAdminModal({
              message: data.message || "Senha alterada com sucesso.",
              success: true,
              type: "senha",
            });
          } else {
            abrirAdminModal({
              message: data.message || "Erro ao alterar senha.",
              success: false,
              type: "senha",
            });
          }
        } catch {
          abrirAdminModal({
            message: "Erro de conexÃ£o com o servidor.",
            success: false,
            type: "senha",
          });
        }
      });
    }

    /* ================= VISIBILIDADE SENHA ================= */
    function toggleAdminPassword(inputId, btn) {
      const input = document.getElementById(inputId);
      if (!input) return;

      const isPassword = input.type === "password";
      input.type = isPassword ? "text" : "password";
      btn.innerText = isPassword ? "ğŸ™ˆ" : "ğŸ‘";
    }
  </script>

  <script src="{{ url_for('static', filename='js/admin_relatorios.js') }}"></script>
  <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>

</html>